name: Financial Agents CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 9 AM UTC to update datasets with latest data
    - cron: '0 9 * * *'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  update-datasets:
    runs-on: ubuntu-latest
    env:
      LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
      LANGSMITH_TRACING: true
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    - name: Install uv
      uses: astral-sh/setup-uv@v1
      with:
        version: "latest"
    - name: Install dependencies
      run: uv sync
    - name: Update financial datasets with today's data
      run: uv run python helpers/create_financial_datasets.py

  run-evaluations:
    needs: update-datasets
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
      LANGSMITH_TRACING: true
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    - name: Install uv
      uses: astral-sh/setup-uv@v1
      with:
        version: "latest"
    - name: Install dependencies
      run: uv sync
    
    - name: Run Portfolio Agent Evaluation (LLM as Judge)
      run: uv run python evals/run_portfolio_eval.py
      continue-on-error: false
    
    - name: Run Market Agent Evaluation (Trajectory)
      run: uv run python evals/run_market_eval.py
      continue-on-error: false
    
    - name: Upload evaluation configs
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-configs
        path: evaluation_config__*.json

  generate-report:
    needs: run-evaluations
    runs-on: ubuntu-latest
    env:
      LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Download evaluation configs
      uses: actions/download-artifact@v4
      with:
        name: evaluation-configs
    
    - name: Install LangSmith SDK
      run: pip install langsmith
    
    - name: Generate evaluation report
      run: python .github/scripts/report_eval.py --verbose evaluation_config__*.json
    
    - name: Upload report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-report
        path: eval_comment.md

  # Notification Job - Using Slack for simplicity
  # For email alternative, you can use dawidd6/action-send-mail@v3 with SMTP configuration
  notify-slack:
    needs: generate-report
    runs-on: ubuntu-latest
    if: always()
    steps:
    - uses: actions/checkout@v4
    
    - name: Download evaluation report
      uses: actions/download-artifact@v4
      with:
        name: evaluation-report
      continue-on-error: true
    
    - name: Prepare Slack message
      id: slack_message
      run: |
        # Determine status
        if [ "${{ needs.run-evaluations.result }}" == "success" ]; then
          STATUS="completed"
        else
          STATUS="failed"
        fi
        
        # Read evaluation report (limit to 1200 chars for Slack, clean special chars)
        if [ -f eval_comment.md ]; then
          # Take first 1200 chars and remove any null bytes or control chars that break JSON
          REPORT=$(head -c 1200 eval_comment.md | tr -d '\000-\010\013\014\016-\037')
        else
          REPORT="Report not available"
        fi
        
        # Use jq to properly create JSON with escaped strings
        jq -n \
          --arg status "$STATUS" \
          --arg repo "${{ github.repository }}" \
          --arg branch "${{ github.ref_name }}" \
          --arg actor "${{ github.actor }}" \
          --arg run_id "${{ github.run_id }}" \
          --arg report "$REPORT" \
          --arg run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          '{
            text: "Financial Agents Evaluation - \($status)",
            blocks: [
              {
                type: "header",
                text: {
                  type: "plain_text",
                  text: "Financial Agents Evaluation"
                }
              },
              {
                type: "section",
                fields: [
                  {type: "mrkdwn", text: "*Status:*\n\($status)"},
                  {type: "mrkdwn", text: "*Branch:*\n\($branch)"},
                  {type: "mrkdwn", text: "*Triggered by:*\n\($actor)"},
                  {type: "mrkdwn", text: "*Repository:*\n\($repo)"}
                ]
              },
              {
                type: "section",
                text: {
                  type: "mrkdwn",
                  text: "*Evaluation Results:*\n```\n\($report)\n```"
                }
              },
              {
                type: "actions",
                elements: [
                  {
                    type: "button",
                    text: {type: "plain_text", text: "View Full Results"},
                    url: $run_url
                  }
                ]
              }
            ]
          }' > slack_message.json
        
        # Verify JSON is valid
        jq . slack_message.json > /dev/null || echo "WARNING: Invalid JSON generated"
        
        echo "status=$STATUS" >> $GITHUB_OUTPUT
    
    - name: Send Slack notification
      uses: slackapi/slack-github-action@v1.25.0
      with:
        payload-file-path: slack_message.json
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
name: Financial Agents CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 9 AM UTC to update datasets with latest data
    - cron: '0 9 * * *'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  update-datasets:
    runs-on: ubuntu-latest
    env:
      LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
      LANGSMITH_TRACING: true
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    - name: Install uv
      uses: astral-sh/setup-uv@v1
      with:
        version: "latest"
    - name: Install dependencies
      run: uv sync
    - name: Update financial datasets with today's data
      run: uv run python helpers/create_financial_datasets.py

  run-evaluations:
    needs: update-datasets
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
      LANGSMITH_TRACING: true
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    - name: Install uv
      uses: astral-sh/setup-uv@v1
      with:
        version: "latest"
    - name: Install dependencies
      run: uv sync
    
    - name: Run Portfolio Agent Evaluation (LLM as Judge)
      run: uv run pytest tests/offline_evals/test_portfolio_agent.py -m evaluator --junitxml=portfolio-eval-results.xml
      continue-on-error: false
    
    - name: Run Market Agent Evaluation (Trajectory)
      run: uv run pytest tests/offline_evals/test_market_agent.py -m evaluator --junitxml=market-eval-results.xml
      continue-on-error: false
    
    - name: Upload evaluation configs
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-configs
        path: evaluation_config__*.json

  generate-report:
    needs: run-evaluations
    runs-on: ubuntu-latest
    env:
      LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Download evaluation configs
      uses: actions/download-artifact@v4
      with:
        name: evaluation-configs
    
    - name: Install LangSmith SDK
      run: pip install langsmith
    
    - name: Generate evaluation report
      run: python .github/scripts/report_eval.py --verbose evaluation_config__*.json
    
    - name: Upload report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-report
        path: eval_comment.md

  # Notification Job - Using Slack for simplicity
  # For email alternative, you can use dawidd6/action-send-mail@v3 with SMTP configuration
  notify-slack:
    needs: generate-report
    runs-on: ubuntu-latest
    if: always()
    steps:
    - uses: actions/checkout@v4
    
    - name: Download evaluation report
      uses: actions/download-artifact@v4
      with:
        name: evaluation-report
      continue-on-error: true
    
    - name: Prepare Slack message
      id: slack_message
      run: |
        # Determine status
        if [ "${{ needs.run-evaluations.result }}" == "success" ]; then
          STATUS="success"
          EMOJI=":white_check_mark:"
        else
          STATUS="failure"
          EMOJI=":x:"
        fi
        
        # Read evaluation report if it exists
        if [ -f eval_comment.md ]; then
          REPORT=$(cat eval_comment.md | head -n 50)
        else
          REPORT="Report not available"
        fi
        
        # Create Slack message payload
        cat > slack_message.json <<EOF
        {
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "$EMOJI Financial Agents Evaluation - $STATUS"
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Repository:*\n${{ github.repository }}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Branch:*\n${{ github.ref_name }}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Triggered by:*\n${{ github.actor }}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Run ID:*\n${{ github.run_id }}"
                }
              ]
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*Evaluation Results:*\n\`\`\`\n$(echo "$REPORT" | head -n 20)\n\`\`\`"
              }
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "View Full Results"
                  },
                  "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
              ]
            }
          ]
        }
        EOF
        
        echo "status=$STATUS" >> $GITHUB_OUTPUT
    
    - name: Send Slack notification
      uses: slackapi/slack-github-action@v1.25.0
      with:
        payload-file-path: slack_message.json
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  post-pr-comment:
    needs: generate-report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
    
    - name: Download evaluation report
      uses: actions/download-artifact@v4
      with:
        name: evaluation-report
    
    - name: Comment PR with evaluation results
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const comment = fs.readFileSync('eval_comment.md', 'utf8');
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

